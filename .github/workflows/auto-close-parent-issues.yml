# Auto-close parent issues when all sub-issues are closed
# This workflow checks if a parent issue should be closed when a linked issue is closed

name: Auto-close Parent Issues

on:
  issues:
    types: [closed]

permissions:
  issues: write
  contents: read

jobs:
  check-parent-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Check and close parent issues
        uses: actions/github-script@v8
        with:
          script: |
            const closedIssue = context.payload.issue;
            console.log(`Issue #${closedIssue.number} was closed: ${closedIssue.title}`);

            // Get all open issues with pagination to find potential parents
            let page = 1;
            const allOpenIssues = [];

            while (true) {
              const { data: openIssues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100,
                page: page
              });

              if (openIssues.length === 0) break;

              allOpenIssues.push(...openIssues);
              page++;

              // Safety limit to prevent infinite loops
              if (page > 50) {
                console.log('Warning: Reached pagination limit of 5000 issues');
                break;
              }
            }

            console.log(`Found ${allOpenIssues.length} open issues to check`);

            for (const parentIssue of allOpenIssues) {
              const body = parentIssue.body || '';

              // Check if this issue references the closed issue as a subtask
              // Only match checkbox-style references: "- [ ] #123" or "- [x] #123"
              const closedIssueCheckboxPattern = new RegExp(`^\\s*[-*]\\s*\\[[x\\s]\\]\\s*#${closedIssue.number}\\b`, 'gim');

              if (!closedIssueCheckboxPattern.test(body)) {
                continue;
              }

              console.log(`Found parent issue #${parentIssue.number}: ${parentIssue.title}`);

              // Extract referenced issue numbers from checkbox items only (subtasks)
              // Pattern: "- [ ] #123" or "- [x] #123" or "* [ ] #123"
              const subtaskPattern = /^\s*[-*]\s*\[[x\s]\]\s*#(\d+)/gim;
              const subtaskNumbers = [];
              let match;

              while ((match = subtaskPattern.exec(body)) !== null) {
                const issueNum = parseInt(match[1]);
                if (issueNum !== parentIssue.number && !subtaskNumbers.includes(issueNum)) {
                  subtaskNumbers.push(issueNum);
                }
              }

              if (subtaskNumbers.length === 0) {
                console.log(`No subtask references found in issue #${parentIssue.number}`);
                continue;
              }

              console.log(`Checking ${subtaskNumbers.length} subtasks: ${subtaskNumbers.join(', ')}`);

              // Check if all referenced issues are closed
              let allClosed = true;
              for (const issueNum of subtaskNumbers) {
                try {
                  const { data: issue } = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNum
                  });

                  if (issue.state === 'open') {
                    console.log(`Subtask #${issueNum} is still open`);
                    allClosed = false;
                    break;
                  }
                } catch (e) {
                  // Issue might not exist or be a PR
                  console.log(`Could not fetch issue #${issueNum}: ${e.message}`);
                }
              }

              if (allClosed) {
                console.log(`All subtasks closed! Closing parent issue #${parentIssue.number}`);

                // Add a comment explaining the auto-close
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parentIssue.number,
                  body: `All subtasks have been completed. Automatically closing this issue.\n\nSubtasks: ${subtaskNumbers.map(n => `#${n}`).join(', ')}`
                });

                // Close the parent issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parentIssue.number,
                  state: 'closed',
                  state_reason: 'completed'
                });

                console.log(`Successfully closed parent issue #${parentIssue.number}`);
              }
            }
