# CI workflow for Go project
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.24"

permissions:
  contents: read
  security-events: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run golangci-lint
        # v6 - pinned to commit SHA for supply chain security
        uses: golangci/golangci-lint-action@55c2c1448f86e01eaae002a5a3a9624417608d84
        with:
          version: latest
          args: --config=.golangci.yml

      - name: Run go vet
        run: go vet ./...

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        # v5 - pinned to commit SHA for supply chain security
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7
        with:
          files: coverage.out
          fail_ci_if_error: false

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build for Linux
        run: |
          GOOS=linux GOARCH=amd64 go build -o build/pve-install-linux-amd64 ./cmd/pve-install
          GOOS=linux GOARCH=arm64 go build -o build/pve-install-linux-arm64 ./cmd/pve-install

      - name: Verify binary
        run: |
          ls -la build/
          file build/pve-install-linux-amd64

  commit-lint:
    name: Commit Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check PR title format
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Check if PR title starts with emoji
          if [[ ! "$PR_TITLE" =~ ^[[:space:]]*[ğŸ¨âœ¨ğŸ”¥ğŸ›ğŸš‘ï¸âœï¸ğŸ’„ğŸ‰âœ…ğŸ”’ï¸ğŸ”ğŸ”–ğŸ’šğŸ‘·ğŸ“ˆâ™»ï¸â•â–ğŸ”§ğŸ”¨ğŸŒğŸ’¬ğŸ—ƒï¸ğŸ”ŠğŸ”‡ğŸ‘¥ğŸš¸ğŸ—ï¸ğŸ“±ğŸ¤¡ğŸ¥šğŸ“ğŸ’©âªï¸ğŸ”€ğŸ“¦ğŸ‘½ï¸ğŸššğŸ“„ğŸ“œğŸš€ğŸ’¥â™¿ï¸ğŸ’¡ğŸ»ğŸºğŸ“¸ğŸ”ï¸ğŸ©ºğŸ§ªğŸ”«ğŸ·ï¸ğŸŒ±ğŸš©ğŸ¥…ğŸ’«ğŸ—‘ï¸ğŸ›‚ğŸ©¹ğŸ§ğŸ“ŒğŸ”¨ğŸ§±ğŸ§ªğŸ¬ğŸ”‡ğŸ™ˆğŸ“¸ğŸ”âš°ï¸ğŸ§‘â€ğŸ’»ğŸ“¦ï¸ğŸ§µğŸ¦ºğŸ›¡ï¸â¬†â¬‡â•â–ğŸš¨ğŸ©ºğŸ¯] ]] && \
             [[ ! "$PR_TITLE" =~ ^[[:space:]]*:[a-z_]+:[[:space:]] ]]; then
            echo "âŒ PR title must start with an emoji"
            echo "Example: âœ¨ feat: add new feature"
            echo "Got: $PR_TITLE"
            exit 1
          fi
          echo "âœ… PR title format is valid: $PR_TITLE"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run gosec
        # v2.22.10 - pinned to commit SHA for supply chain security
        uses: securego/gosec@6be2b51fd78feca86af91f5186b7964d76cb1256
        with:
          # G104: unhandled errors (handled by golangci-lint errcheck)
          # G304: file path from variable (mitigated via nolint comments where appropriate)
          args: -exclude=G104,G304 -fmt sarif -out gosec-results.sarif ./...

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-results.sarif
