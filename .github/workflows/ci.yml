# CI workflow for Go project
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out
          fail_ci_if_error: false

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build for Linux
        run: |
          GOOS=linux GOARCH=amd64 go build -o build/pve-install-linux-amd64 ./cmd/pve-install
          GOOS=linux GOARCH=arm64 go build -o build/pve-install-linux-arm64 ./cmd/pve-install

      - name: Verify binary
        run: |
          ls -la build/
          file build/pve-install-linux-amd64

  commit-lint:
    name: Commit Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          # Check if PR title starts with emoji
          if [[ ! "$PR_TITLE" =~ ^[[:space:]]*[ğŸ¨âœ¨ğŸ”¥ğŸ›ğŸš‘ï¸âœï¸ğŸ’„ğŸ‰âœ…ğŸ”’ï¸ğŸ”ğŸ”–ğŸ’šğŸ‘·ğŸ“ˆâ™»ï¸â•â–ğŸ”§ğŸ”¨ğŸŒğŸ’¬ğŸ—ƒï¸ğŸ”ŠğŸ”‡ğŸ‘¥ğŸš¸ğŸ—ï¸ğŸ“±ğŸ¤¡ğŸ¥šğŸ“ğŸ’©âªï¸ğŸ”€ğŸ“¦ğŸ‘½ï¸ğŸššğŸ“„ğŸ“œğŸš€ğŸ’¥â™¿ï¸ğŸ’¡ğŸ»ğŸºğŸ“¸ğŸ”ï¸ğŸ©ºğŸ§ªğŸ”«ğŸ·ï¸ğŸŒ±ğŸš©ğŸ¥…ğŸ’«ğŸ—‘ï¸ğŸ›‚ğŸ©¹ğŸ§ğŸ“ŒğŸ”¨ğŸ§±ğŸ§ªğŸ¬ğŸ”‡ğŸ™ˆğŸ“¸ğŸ”âš°ï¸ğŸ§‘â€ğŸ’»ğŸ“¦ï¸ğŸ§µğŸ¦ºğŸ›¡ï¸â¬†ï¸â¬‡ï¸â•â–ğŸš¨ğŸ©ºğŸ¯][[:space:]] ]] && \
             [[ ! "$PR_TITLE" =~ ^[[:space:]]*:[a-z_]+:[[:space:]] ]]; then
            echo "âŒ PR title must start with an emoji"
            echo "Example: âœ¨ feat: add new feature"
            echo "Got: $PR_TITLE"
            exit 1
          fi
          echo "âœ… PR title format is valid: $PR_TITLE"
